@page "/"
@inject AASService SubmodelService
@inject NavigationManager NavigationManager
@inject ISecurityService SecService
@using AasCore.Aas3_0
@using AasSecurity;
@using AasSecurity.Models;
@using Extensions
@using Microsoft.IdentityModel.Tokens;
@using System
@using System.Net;
@using QRCoder;
@using System.Drawing;
@using System.IO;
@using AasxServerBlazor.Data
@*@using static AdminShellNS.AdminShellV30;*@
@using static AasxServerStandardBib.TimeSeriesPlotting;

@implements IDisposable

<div class="col-12 row">
    <br />
    <div class="col-4" style="border-width:3px; border-style: solid; border-color: blue; border-radius: 8px; word-wrap: break-word; word-break: break-all; position: sticky">
        @updateVisibleTree(Items, selectedNode)
        @if (Program.isLoading)
        {<span style="color:white;background-color:blue;">Loading...</span>
        }
        else
        { 
            // IO.Swagger.Registry.Controllers.RegistryAndDiscoveryInterfaceApiController.initRegistry(DateTime.UtcNow);
            AasxRestServerLibrary.AasxRestServer.TestResource.initListOfRepositories();
        }
        <Tree Nodes="Items" ChildSelector="@(item => item.Childs)"
              @bind-SelectedNode="SelectedNode"
              @bind-ExpandedNodes="ExpandedNodes"
              HasChildNodes="@(item => item.Childs?.Any() == true)"
              HtmlId="@(item => GetHtmlId(item))">
            <TitleTemplate>
                @{ //// SubmodelService.syncSubTree(context);
                }
                @*//No need for "Coll" to be red, now "Coll" is part of V3
                @if(IsSmColl(context))
                {
                    <span style="color:white;background-color:red;">@ViewNodeType(context)</span>
                }
                else
                {
                    <span style="color:white;background-color:blue;">@ViewNodeType(context)</span>
                }*@
                @* @if (AasxRestServerLibrary.AasxHttpContextHelper.withAuthentification) *@
                @if (GlobalSecurityVariables.WithAuthentication)
                {
                    var display = false;
                    var access = false;
                    bool withAllow = false;
                    if (context.Tag is Submodel sm)
                    {
                        // check, if access to submodel is allowed
                        @* access = AasxRestServerLibrary.AasxHttpContextHelper.checkAccessLevelWithAllow(
                            null, "/submodels", "READ", out withAllow,
                                sm.IdShort, "sm", sm); *@
                        access = SecService.AuthorizeRequest(null, "/submodels", AccessRights.READ, out string error,out withAllow,sm.IdShort!, "submodel", sm);
                        @* access = TestSecurityBlazor.CheckAccessRightsWithAllow(null, "/submodels", AccessRights.READ, out string error,out withAllow, sm.IdShort!, "submodel", sm); *@
                        display = true;
                    }
                    if (context.Tag is ISubmodelElement sme)
                    {
                        string path = sme.IdShort;
                        var p = sme.Parent;
                        while (!(p is Submodel))
                        {
                            path = (p as ISubmodelElement).IdShort + "." + path;
                            p = (p as ISubmodelElement).Parent;
                        }
                        path = (p as Submodel).IdShort + "." + path;
                        // check, if access to submodelelement is allowed
                        @* access = AasxRestServerLibrary.AasxHttpContextHelper.checkAccessLevelWithAllow(
                            null, "/submodelelements", "READ", out withAllow,
                                path, "", p); *@
                        access = SecService.AuthorizeRequest(null, "/submodel-elements", AccessRights.READ, out string error, out withAllow, path, "", p);
                        display = true;
                    }
                    if (display)
                    {
                        if (context.Childs == null || context.Childs.Count() == 0)
                            withAllow = false;
                        if (access)
                        {
                            <span style="color:green;background-color:green;">&nbsp&nbsp</span>
                            <span>&nbsp</span>
                        }
                        else
                        {
                            if (!withAllow)
                            {
                                <span style="color:red;background-color:red;">&nbsp&nbsp</span>
                                <span>&nbsp</span>
                            }
                            else
                            {
                                <span style="color:red;background-color:red;">&nbsp</span><span style="color:green;background-color:green;">&nbsp</span>
                                <span>&nbsp</span>
                            }
                        }
                    }
                }
                <span style="color:white;background-color:blue;">@ViewNodeType(context)</span>
                @ViewNodeID(context)@ViewNodeInfo(context)
                <strong><span style="color:blue">@getSymbols(context)</span></strong>
                <span style="color:lightgray;">@ViewTimeStamp(context)</span>
            </TitleTemplate>
        </Tree>
    </div>
    <div class="col-8" style="border-width: 3px; border-style: solid; border-color: blue; border-radius: 8px; position: sticky">
        <div class="sticky-top" style="word-wrap:break-word;word-break:break-all;">
            @{
                if (selectedNode != null)
                {
                    if (!(selectedNode.Tag is string))
                    {
                        <span style="color:white;background-color:blue;" id="SelectedNodeInfoType">@ViewNodeType(selectedNode)</span>
                        <span id="SelectedNodeInfoId">@ViewNodeID(selectedNode)</span>
                        <br>
                    }
                    else
                    {
                        if (selectedNode.Tag is string && selectedNode.Text.Contains("/readme"))
                        {
                            string text = System.IO.File.ReadAllText(selectedNode.Text);
                            text = text.Replace("%BLAZOR%", Program.externalBlazor);
                            if (text.Contains("%ACCESSRULES%"))
                            {
                                // string accessRules = AasxRestServerLibrary.AasxHttpContextHelper.securityAccessRules();
                                string accessRules = SecService.GetSecurityRules();
                                <table class="table table-bordered table-sm">
                                @*<table border=1 cellpadding=4>*@
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th nowrap>Kind</th>
                                            <th>Permission</th>
                                            <th>Type</th>
                                            <th>API</th>
                                            <th>Path</th>
                                            <th>SemanticID</th>
                                            <th>See</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @{
                                            var lines = accessRules.Split('\n');
                                            foreach (var l in lines)
                                            {
                                                <tr>
                                                    @{
                                                        var cols = l.Split('\t');
                                                        for (int c = 0; c < cols.Count(); c++)
                                                        {
                                                            if (c != 1 && c!= 2)
                                                            {
                                                                <td>@cols[c]</td>
                                                            }
                                                            else
                                                            {
                                                                <td nowrap>@cols[c]</td>
                                                            }
                                                        }
                                                }
                                                </tr>
                                            }
                                        }
                                    </tbody>
                                </table>
                            }
                            else
                            {
                                <span>@((MarkupString)text)</span>
                            }
                        }
                    }
                }
                for (int line = 0; line < 6; line++)
                {
                    string nodeDetails0 = ViewNodeDetails(selectedNode, line, 0);
                    string nodeDetails1 = ViewNodeDetails(selectedNode, line, 1);
                    string nodeDetails2 = ViewNodeDetails(selectedNode, line, 2);
                    if (nodeDetails0 != "" && nodeDetails1 != "")
                    {
                        string detailsId="SelectedNodeDetailsLeft_" + line;
                        <span style="color:white;background-color:blue;" id="@detailsId">@nodeDetails0</span>
                        detailsId = "SelectedNodeDetailsRight_" + line;
                        <span id="@detailsId">&nbsp;@nodeDetails1 @nodeDetails2</span>
                        <br>
                    }
                }
                if (selectedNode != null && selectedNode.Tag is IReferable r)
                {
                    <span style="color:lightgray;">UPDATE @r.TimeStamp.ToString("yy-MM-dd HH:mm:ss.fff")</span><br />
                    <button style="border-width: 1px; border-color: black; background-color: lightgray" @onclick="setTimeStamp">TIMESTAMP</button><br />
                    <span style="color:lightgray;">CREATE @r.TimeStampCreate.ToString("yy-MM-dd HH:mm:ss.fff")</span><br />
                    <span style="color:lightgray;">TREE @r.TimeStampTree.ToString("yy-MM-dd HH:mm:ss.fff")</span>

                    <br />
                    @code {
                        private void setTimeStamp()
                        {
                            (selectedNode.Tag as IReferable).SetTimeStamp(DateTime.UtcNow);
                        }
                    }
                }
                // if (selectedNode != null && hasDownloadFile(selectedNode))
                // {
                //     <button @onclick="DownloadFile">Download File</button><br>
                //     <img src="test.jpg" alt="Thumbnail" />
                // }
                bool externalLink = false;
                string link = getLink(selectedNode, out externalLink);
                if (selectedNode != null && link != "")
                {
                    // if (externalLink)
                    if (true)
                    {
                        <a href="@link" target="_blank">@link</a><br>
                    }
                    else
                    {
                        <button onclick="window.location.href = '@link'; ">Download</button><br>
                    }
                    if (selectedNode != null && selectedNode.Tag is Submodel && Program.connectServer != "")
                    {
                        bool toPublish = Program.submodelsToPublish.Contains(selectedNode.Tag);
                        bool toSubscribe = Program.submodelsToSubscribe.Contains(selectedNode.Tag);
                        if (toPublish)
                        {
                            <button style="color:white;background-color:blue" @onclick="resetSubmodelToPublish">Publish</button>
                        }
                        else
                        {
                            <button @onclick="setSubmodelToPublish">Publish</button>
                        }
                        if (toSubscribe)
                        {
                            <button style="color:white;background-color:blue" @onclick="resetSubmodelToSubscribe">Subscribe</button>
                        }
                        else
                        {
                            <button @onclick="setSubmodelToSubscribe">Subscribe</button>
                        }
                        // <button onclick="window.location.href = '@link';">Subscribe</button><br>
                        @code {
                            private void resetSubmodelToPublish()
                            {
                                Program.submodelsToPublish.Remove(selectedNode.Tag);
                            }
                            private void setSubmodelToPublish()
                            {
                                bool toSubscribe = Program.submodelsToSubscribe.Contains(selectedNode.Tag);
                                if (!toSubscribe)
                                    Program.submodelsToPublish.Add(selectedNode.Tag);
                            }
                            private void resetSubmodelToSubscribe()
                            {
                                Program.submodelsToSubscribe.Remove(selectedNode.Tag);
                            }
                            private void setSubmodelToSubscribe()
                            {
                                bool toPublish = Program.submodelsToPublish.Contains(selectedNode.Tag);
                                if (!toPublish)
                                    Program.submodelsToSubscribe.Add(selectedNode.Tag);
                            }
                        }
                    }
                }
                if (selectedNode != null && selectedNode.Tag is Property && Program.edit)
                {
                    // <input @bind="CurrentValue" @bind:event="oninput" /> <span style="color:white;background-color:blue;">@CurrentValue</span><br>
                    <input @bind="CurrentValue" /> <span style="border-width: 1px; border-color: black; background-color: blue;">@CurrentValue</span><br>
                    @code { private string CurrentValue { get; set; } }
                    if (CurrentValue != null && CurrentValue != "")
                    {
                        if (selectedNode.Tag is Property)
                        {
                            (selectedNode.Tag as Property).Value = CurrentValue;
                            (selectedNode.Tag as Property).SetTimeStamp(DateTime.UtcNow);
                            this.StateHasChanged();
                        }
                        CurrentValue = "";
                    }
                }
                if (selectedNode != null && (selectedNode.Tag is AssetAdministrationShell || selectedNode.Tag is AasCore.Aas3_0.File))
                {
                    if (selectedNode.Tag is AssetAdministrationShell)
                    {
                        <button style="border-width: 1px; border-color: black; color: white; background-color: blue" @onclick="runCreateQRCodeImage">QRCODE</button><br />
                        string qrcodeLink = getQRCodeLink(selectedNode);
                        if (Program.generatedQrCodes.ContainsKey(selectedNode.Tag))
                        {
                            string qrcodeImage = getQRCodeImage(selectedNode);
                            if (qrcodeImage != "")
                            {
                                <a href="@qrcodeLink" target="_blank">
                                    <div>
                                        <img src=data:image;base64,@qrcodeImage style="max-width: 25%;" alt="Qrcode Image" />
                                    </div>
                                </a>
                            }
                        }
                        else
                        {
                            <a href="@qrcodeLink" target="_blank">@qrcodeLink</a><br>
                        }
                        @code {
                            private void runCreateQRCodeImage()
                            {
                                createQRCodeImage(selectedNode);
                            }
                        }
                    }
                }

                if (selectedNode != null && selectedNode.Tag is Submodel sm)
                {
                    var idEncoded = Base64UrlEncoder.Encode(sm.Id);
                    var path = Program.externalBlazor + "/submodels/" + idEncoded;
                    <span style="color:white;background-color:blue;">URL:</span>
                    <span>&nbsp</span>
                    <a href="@path" target="_blank">@path</a><br>
                }

                if (selectedNode != null && selectedNode.Tag is ISubmodelElement sme)
                {
                    string path = sme.IdShort;
                    var p = sme.Parent;
                    while (!(p is Submodel))
                    {
                        path = (p as ISubmodelElement).IdShort + "." + path;
                        p = (p as ISubmodelElement).Parent;
                    }
                    var idEncoded = Base64UrlEncoder.Encode((p as Submodel).Id);
                    // path = Program.externalBlazor + "/submodels/" + idEncoded + "/submodelelements/" + path;
                    path = Program.externalBlazor + "/submodels/" + idEncoded + "/submodel-elements/" + path;
                    <span style="color:white;background-color:blue;">URL:</span>
                    <span>&nbsp</span>
                    <a href="@path" target="_blank">@path</a><br>
                }

                if (selectedNode != null && selectedNode.Tag is SubmodelElementCollection smc)
                {
                    string semanticId = "";
                    // bool render = false;

                    try
                    {
                        semanticId = smc.SemanticId?.GetAsIdentifier();
                    }
                    catch { }
                    if (semanticId == "https://admin-shell.io/sandbox/zvei/TimeSeriesData/TimeSeries/1/0" ||
                        semanticId == "https://admin-shell.io/sandbox/zvei/TimeSeriesData/TimeSeriesSegment/1/0")
                    {
                        TimeSpan diff = smc.TimeStamp - timeStampPlot;

                        if (smc != collectionPlot || diff.TotalSeconds < 0 || diff.TotalSeconds >= 5)
                        {
                            watchTimeToProcessImage = System.Diagnostics.Stopwatch.StartNew();

                            collectionPlot = smc;
                            timeStampPlot = smc.TimeStamp;

                            //ListOfTimeSeriesData _timeSeriesData = new ListOfTimeSeriesData();
                            _timeSeriesData.Clear();
                            //var mm = AdminShell.Key.MatchMode.Relaxed;

                            // make initial data for time series
                            var tsd = new TimeSeriesData() { SourceTimeSeries = smc };
                            _timeSeriesData.Add(tsd);

                            // plot arguments for time series
                            tsd.Args = PlotArguments.Parse(smc.FindQualifierOfType("TimeSeries.Args")?.Value);

                            // TODO: info - ZveiTimeSeriesDataV10 is currently hardcoded as JSON string in code
                            var pcts = ZveiTimeSeriesDataV10.Static;

                            //var tssReference = pcts.CD_TimeSeriesSegment.GetReference();
                            var tssReference = pcts.CD_TimeSeriesSegment.GetCdReference();
                            //var k = new Key("ConceptDescription", false, "IRI", "https://admin-shell.io/sandbox/zvei/TimeSeriesData/TimeSeriesSegment/1/0");
                            //var tssReference = new Reference(k);
                            //var smcAllValues = smc.value.FindAllSemanticIdAs<AdminShell.SubmodelElementCollection>(tssReference, mm);

                            // is it a segment
                            if (semanticId == "https://admin-shell.io/sandbox/zvei/TimeSeriesData/TimeSeriesSegment/1/0")
                            {
                                TimeSeriesAddSegmentData(pcts, tsd, smc);
                            }
                            else
                            {
                                // search for segements on current level
                                var smcAllValues = smc.Value.FindAllSemanticIdAs<SubmodelElementCollection>(tssReference.GetAsExactlyOneKey().Value);

        if (smcAllValues.Count() != 0)
        {
            foreach (var smcseg in smcAllValues)
            {
                TimeSeriesAddSegmentData(pcts, tsd, smcseg);
            }
        }
    }

                            _timeSeriesData?.RenderTimeSeries(defPlotHeight: 200, "en", bi.sessionNumber, plotFilter.combinedFromDate, plotFilter.combinedToDate);
                            watchTimeToProcessImage.Stop();
                        }

                        byte[] imageArray;
                        string timeSeriesImageBase64 = "";
                        string scottplotImgPath = "wwwroot/images/scottplot/smc_timeseries_clientid" + bi.sessionNumber + ".png";

                        if (System.IO.File.Exists(scottplotImgPath))
                        {
                            imageArray = System.IO.File.ReadAllBytes(scottplotImgPath);
                            timeSeriesImageBase64 = Convert.ToBase64String(imageArray);
                        }

                        var elapsedMsToProcessImage = watchTimeToProcessImage.ElapsedMilliseconds;

                        if (System.IO.File.Exists(scottplotImgPath))
                        {
                            <EditForm Model="@plotFilter" OnValidSubmit="() => plotFilter.UpdateFilter(_timeSeriesData, bi.sessionNumber)">
                                <label for="filterFromDate">Filter from</label>
                                <InputDate id="filterFromDate" @bind-Value="plotFilter.fromDate" />
                                <input type="time" @bind-value="plotFilter.fromTime" />
                                <label for="filterToDate">Filter to</label>
                                <InputDate id="filterToDate" @bind-Value="plotFilter.toDate" />
                                <input type="time" @bind-value="plotFilter.toTime" />
                                <div>
                                    <button type="submit">Apply</button>
                                    <button @onclick="plotFilter.SetInitialFilterState">Reset</button>
                                    <button @onclick="() => { plotFilterTsdOffset = 0; plotFilter.SetFilterStateDay(0); }">Today</button>
                                    <button @onclick="() => { plotFilterTsdOffset = -1; plotFilter.SetFilterStateDay(-1); }">Yesterday</button>
                                    <button @onclick="() => plotFilter.SetFilterStateDay(--plotFilterTsdOffset)">Prev day</button>
                                    <button @onclick="() => plotFilter.SetFilterStateDay(++plotFilterTsdOffset)">Next day</button>
                                </div>
                            </EditForm>

                            <div class="d-flex flex-column">
                                <img @onclick="() => showImageModal = !showImageModal" src=data:image;base64,@timeSeriesImageBase64 alt="Visualization of time series" style="max-width:950px;cursor:zoom-in;" />
                                <span class="text-muted" style="font-size:14px;">
                                    Image processing took @elapsedMsToProcessImage ms (Last update: @timeStampPlot.ToString("yy-MM-dd HH:mm:ss.fff"))
                                </span>
                            </div>

                            <div class="modal modal-fullscreen @(showImageModal ? " d-block" : "d-none" )" style="margin-top:3.5rem;" tabindex="-1">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Visualization of time series</h5>
                                            <button type="button" @onclick="() => showImageModal = !showImageModal" class="close" data-dismiss="modal" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                        <div class="modal-body text-center">
                                            <img @onclick="() => showImageModal = !showImageModal" src=data:image;base64,@timeSeriesImageBase64 alt="Visualization of time series" style="max-width:90%;max-height:90%;cursor:zoom-out;" class="mb-2" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="my-2">Rendering time series...</div>
                        }
                    }
                    else
                    {
                        collectionPlot = null;
                    }
                }
            }

            @{
                string detailsImage = createDetailsImage(selectedNode);
                if (detailsImage != "")
                {
                    <br />
                    <div>
                        <img src=data:image;base64,@detailsImage style="max-width: 50%" alt="Details Image" />
                    </div>
                }

                if (selectedNode != null && (selectedNode.Tag is BasicEventElement be))
                {
                    if (be.Observed != null)
                    {
                        string okey = be.Observed.GetAsExactlyOneKey().ToStringExtended();
                        <span style="color:white;background-color:blue;">Observed</span>
                        <span>@(" " + okey)</span><br />
                        var refsme = Program.env[0].AasEnv.FindReferableByReference(be.Observed);
                        if (refsme != null)
                        {
                            <span style="color:lightgray;">UPDATE @refsme.TimeStamp.ToString("yy-MM-dd HH:mm:ss.fff")</span><br />
                            <span style="color:lightgray;">CREATE @refsme.TimeStampCreate.ToString("yy-MM-dd HH:mm:ss.fff")</span><br />
                        }
                        else
                        {
                            <span>Referenced element does not exist!</span><br />
                        }
                    }
                }
            }
        </div>
    </div>
</div>


@inject IJSRuntime js
@inject BlazorSessionService bi;
@using AasxServer;
@using AdminShellNS;
@using System.Globalization;
@using System.Reflection;
@using Newtonsoft.Json;
@using Newtonsoft.Json.Linq;
@using ScottPlot;

@code {
    System.Diagnostics.Stopwatch watchTimeToProcessImage = new System.Diagnostics.Stopwatch();
    DateTime timeStampPlot = new DateTime();
    PlotFilter plotFilter = new PlotFilter();
    SubmodelElementCollection collectionPlot = null;
    bool showImageModal = false;
    ListOfTimeSeriesData _timeSeriesData = new ListOfTimeSeriesData();
    int plotFilterTsdOffset = 0;

    private class PlotFilter
    {
        public DateTime fromDate { get; set; }
        public DateTime fromTime { get; set; }
        public DateTime toDate { get; set; }
        public DateTime toTime { get; set; }
        public DateTime combinedFromDate { get; set; }
        public DateTime combinedToDate { get; set; }

        public PlotFilter()
        {
            this.SetInitialFilterState();
        }

        public void SetInitialFilterState()
        {
            ResetTimeOfDates();
            var initialFromDate = DateTime.Now.AddYears(-3);
            var initialToDate = DateTime.Now.AddYears(3);
            fromDate = initialFromDate;
            toDate = initialToDate;
            combinedFromDate = initialFromDate;
            combinedToDate = initialToDate;
        }

        public void SetFilterStateDay(int offset)
        {
            ResetTimeOfDates();
            DateTime day = DateTime.Today.AddDays(offset);
            TimeSpan midnight = new System.TimeSpan(0, 23, 59, 59);
            DateTime endOfDay = day.Add(midnight);

            fromDate = day;
            fromTime = day;
            toDate = endOfDay;
            toTime = endOfDay;
            combinedFromDate = day;
            combinedToDate = endOfDay;
        }

        public void ResetTimeOfDates()
        {
            // Reset to 0 AM
            fromDate = new DateTime(fromDate.Year, fromDate.Month, fromDate.Day, 0, 0, 0);
            toDate = new DateTime(toDate.Year, toDate.Month, toDate.Day, 0, 0, 0);
        }

        public void UpdateFilter(ListOfTimeSeriesData tsd, int sessionNumber)
        {
            ResetTimeOfDates();
            TimeSpan fromTimeSpan = fromTime.TimeOfDay;
            TimeSpan toTimeSpan = toTime.TimeOfDay;
            combinedFromDate = fromDate.Add(fromTimeSpan);
            combinedToDate = toDate.Add(toTimeSpan);
            tsd?.RenderTimeSeries(defPlotHeight: 200, "en", sessionNumber, combinedFromDate, combinedToDate);
        }
    }

    async Task DownloadFile()
    {
        this.StateHasChanged();
        var f = selectedNode.Tag as AasCore.Aas3_0.File;
        var fileName = System.IO.Path.GetFileName(f.Value);
        if (fileName != "")
        {
            try
            {
                byte[] data;
                using (System.IO.MemoryStream ms = new System.IO.MemoryStream())
                {
                    Program.env[selectedNode.envIndex].GetLocalStreamFromPackage(f.Value).CopyTo(ms);
                    data = ms.ToArray();
                }
                //
                await SaveAs(js, fileName, data);
            }
            catch
            {
            }

        }
    }
    async Task SaveAs(IJSRuntime js, string filename, byte[] data)
    // async Task SaveAs(IJSRuntime js, string filename, string data)
    {
        ; await js.InvokeAsync<object>(
     "saveAsFile",
     filename,
     data
     );
    /*
    await js.InvokeAsync<object>(
        "saveAsFile",
        filename,
        Convert.ToBase64String(data)
        );
        */
        /*
        await js.InvokeAsync<object>(
            "download",
            data,
            filename,
            "application/pdf"
    );
    */
    }

    public class Item
    {
        public string Text { get; set; }
        public IEnumerable<Item> Childs { get; set; }
        public object parent { get; set; }
        // public List<Item> Childs { get; set; }
        public string Type { get; set; }
        public object Tag { get; set; }
        public int envIndex { get; set; }
    }

    List<Item> Items = null;

    IList<Item> ExpandedNodes = new List<Item>();
    Item selectedNode;
    Item SelectedNode
    {
        get { return selectedNode; }
        set
        {
            selectedNode = value;
            // OnSelectNode(selectedNode);
        }
    }

    static ulong dataVersion = 0;

    public static void checkDataVersion()
    {
        if (Program.getDataVersion() != dataVersion)
        {
            dataVersion = Program.getDataVersion();
            // TreePage.StateHasChanged();
        }
    }

    static int hack = 0;

    System.Threading.Timer refresh = null;

    protected override void OnInitialized()
    {
        // OnInitialized() allways called twice
        // if (hack++ == 0)
        //    return;

        // hack = 0;
        // SubmodelService.buildTree();
        // Items = SubmodelService.GetTree(selectedNode, ExpandedNodes);
        // newDataMode = 1;
        // StateHasChanged();

        //ExpandedNodes.Add(Items.Skip(1).First());
        //ExpandedNodes.Add(Items.Skip(1).Take(1).First().Childs.Skip(1).First());

        SubmodelService.NewDataAvailable += NewData;
        Program.signalNewData(1);

        /*
        refresh = new System.Threading.Timer(new System.Threading.TimerCallback(_ =>
            {
            // Note that the following line is necessary because otherwise
            // Blazor would not recognize the state change and not refresh the UI
            // InvokeAsync(() => this.StateHasChanged());
        }), null, 5000, 5000);
    */
    }

    public void Dispose()
    {
        SubmodelService.NewDataAvailable -= NewData;
    }

    int newDataMode = 0;

    void NewData(object source, EventArgs args)
    {
        if (Program.isLoading)
            return;

        // update = true;
        if (newDataMode == 0)
        {
            if (args is Program.NewDataAvailableArgs newArgs)
            {
                newDataMode = newArgs.signalNewDataMode;
                // Items = SubmodelService.GetTree(selectedNode, ExpandedNodes);
                InvokeAsync(() => this.StateHasChanged());
            }
        }
        // newDataMode = Program.getSignalNewDataMode();
        // Items = SubmodelService.GetTree(selectedNode, ExpandedNodes);

        // InvokeAsync(() => this.StateHasChanged());
        // this.StateHasChanged();
    }

    bool update = true;

    string updateVisibleTree(List<Item> viewItems, Item selectedNode)
    {
        if (update)
        {
            switch (newDataMode)
            {
                // 0 == same tree, only values changed
                case 0:
                    break;
                // 1 == same tree, structure may change
                // 2 == build new tree, keep open nodes
                case 1:
                case 2:
                    bool isSelected = selectedNode != null;
                    bool isExpanded = ExpandedNodes.Count != 0;
                    List<string>[] expandedNodesPath = new List<string>[ExpandedNodes.Count + 1];
                    List<string> selectedNodePath = getPath(selectedNode);
                    if (isExpanded)
                    {
                        for (int j = 0; j < ExpandedNodes.Count; j++)
                        {
                            expandedNodesPath[j] = getPath(ExpandedNodes[j]);
                        }
                    }
                    SubmodelService.buildTree();
                    Items = SubmodelService.GetTree(selectedNode, ExpandedNodes);
                    ExpandedNodes.Clear();
                    selectedNode = null;
                    if (isSelected)
                    {
                        selectedNode = findPath(selectedNodePath);
                    }
                    if (isExpanded)
                    {
                        foreach (var path in expandedNodesPath)
                        {
                            Item p = findPath(path);
                            if (p != null)
                                ExpandedNodes.Add(p);
                        }
                    }
                    newDataMode = 0;
                    break;
                // 3 == build new tree, all nodes closed
                case 3:
                    SubmodelService.buildTree();
                    Items = SubmodelService.GetTree(selectedNode, ExpandedNodes);
                    ExpandedNodes.Clear();
                    selectedNode = null;
                    newDataMode = 0;
                    break;
            }
            SelectedNode = selectedNode;
            // update = false;
            // updateNode(viewItems[0]);
        }
        return "";
    }

    List<string> getPath(Item i)
    {
        if (i == null)
            return null;

        List<string> upPath = new List<string>();
        upPath.Add(i.Text);
        while (i.parent != null)
        {
            i = (Item)i.parent;
            upPath.Add(i.Text);
        }
        List<string> downPath = new List<string>();
        int j = upPath.Count - 1;
        while (j >= 0)
        {
            downPath.Add(upPath[j--]);
        }
        return downPath;
    }

    Item findPath(List<string> path)
    {
        if (path != null && path.Count > 0)
        {
            Item found = null;
            int k = 0;
            while (k < Items.Count)
            {
                Item i = Items[k];
                if (i.Text != path[0])
                {
                    k++;
                    continue;
                }
                int j = 0;
                found = i;
                while (++j < path.Count)
                {
                    if (i.Childs != null)
                    {
                        found = null;
                        foreach (var c in i.Childs)
                        {
                            if (c.Text == path[j])
                            {
                                found = c;
                                break;
                            }
                        }
                    }
                    if (found == null)
                    {
                        return null;
                    }
                    i = found;
                }
                if (found != null)
                    return found;
            }
        }
        return null;
    }

    void updateNode(Item i)
    {
        var clist = i.Childs as List<Item>;
        List<string> listIdshort = new List<string>();
        bool done = false;
        if (!done && i.Tag is Submodel sm)
        {
            foreach (var smew1 in sm.SubmodelElements)
            {
                listIdshort.Add(smew1.IdShort);
            }
            done = true;
        }
        if (!done && i.Tag is SubmodelElementCollection smec)
        {
            foreach (var smew2 in smec.Value)
            {
                listIdshort.Add(smew2.IdShort);
            }
            done = true;
        }
        if (!done && i.Tag is ISubmodelElement sme)
        {
            listIdshort.Add(sme.IdShort);
            done = true;
        }
        // check if child name exists in data children idshorts, if not delete
        if (done)
        {
            List<Item> toDelete = new List<Item>();
            if (clist != null)
            {
                foreach (var c in clist)
                {
                    if (!listIdshort.Contains(c.Text))
                    {
                        toDelete.Add(c);
                    }
                }
            }
            else
            {
                if (!listIdshort.Contains(i.Text))
                {
                    toDelete.Add(i);
                }
            }
            foreach (var c in toDelete)
            {
                var parent = c.parent as Item;
                if (parent != null)
                {
                    (parent.Childs as List<Item>).Remove(c);
                }
            }
        }
        // check if data children idshorts exist in child names, if not insert
        if (clist != null)
        {
            foreach (var c in clist)
            {
                updateNode(c);
            }
        }
    }

    string createDetailsImage(Item item)
    {
        // System.IO.File.Delete("wwwroot/detailsImage.jpg");

        if (item == null)
        {
            return "";
        }

        object o = item.Tag;

        if (o is AssetAdministrationShell)
        {
            var aas = o as AssetAdministrationShell;
            lock (Program.changeAasxFile)
            {
                try
                {
                    using (System.IO.Stream s = Program.env[item.envIndex].GetLocalThumbnailStream())
                    {
                        if (s != null)
                        {
                            using (var m = new System.IO.MemoryStream())
                            {
                                s.CopyTo(m);
                                return System.Convert.ToBase64String(m.ToArray());
                            }
                        }

                    }
                }
                catch { }
            }
        }

        if (o is AasCore.Aas3_0.File f)
        {

            // Test for /aasx/
            if (!string.IsNullOrEmpty(f.Value))
            {
                string[] split = f.Value.Split(new Char[] { '/' });
                if (split.Length == 2 || split.Length > 1 && split[1].ToLower() == "aasx")
                {
                    split = f.Value.Split(new Char[] { '.' });
                    switch (split.Last().ToLower())
                    {
                        case "jpg":
                        case "bmp":
                        case "png":
                            try
                            {
                                using (System.IO.Stream s = Program.env[item.envIndex].GetLocalStreamFromPackage(f.Value))
                                {
                                    if (s != null)
                                    {
                                        using (var m = new System.IO.MemoryStream())
                                        {
                                            s.CopyTo(m);
                                            return System.Convert.ToBase64String(m.ToArray());
                                        }
                                    }
                                }
                            }
                            catch { }
                            break;
                    }
                }
            }
        }

        return "";
    }

    string getQRCodeLink(Item item)
    {
        if (item == null)
        {
            return "";
        }

        string prefix = "http://";
        string hostPort = Program.hostPort;

        string[] split = Program.hostPort.Split(':');
        if (split[0].ToLower() == "admin-shell-io.com")
        {
            // prefix = "https://";
            // hostPort = split[0] + ":" + (Convert.ToInt32(split[1]) + 1);
        }

        object o = item.Tag;

        if (o is AssetAdministrationShell)
        {
            var aas = o as AssetAdministrationShell;
            var asset = aas.AssetInformation;
            if (asset != null)
            {
                // string url = WebUtility.UrlEncode(asset.identification.id);
                string url = asset.GlobalAssetId;
                // string link = prefix + hostPort + "/server/getaasxbyassetid/" + url;
                // string link = Program.externalRest + "/server/getaasxbyassetid/" + url;
                string link = url;

                return link;
            }
        }

        return "";
    }

    string getQRCodeImage(Item item)
    {
        if (item == null)
        {
            return "";
        }

        object o = item.Tag;

        if (o is AssetAdministrationShell)
        {
            string image = Program.generatedQrCodes[item.Tag];

            if (image != null)
                return image;
        }

        return "";
    }

    void createQRCodeImage(Item item)
    {
        // System.IO.File.Delete("wwwroot/detailsImage.jpg");

        if (item == null)
        {
            return;
        }

        string prefix = "http://";
        string hostPort = Program.hostPort;

        string[] split = Program.hostPort.Split(':');
        if (split[0].ToLower() == "admin-shell-io.com")
        {
            // prefix = "https://";
            // hostPort = split[0] + ":" + (Convert.ToInt32(split[1]) + 1);
        }

        object o = item.Tag;

        if (o is AssetAdministrationShell)
        {
            if (Program.generatedQrCodes.ContainsKey(item.Tag))
            {
                Program.generatedQrCodes.Remove(item.Tag);
                return;
            }

            var aas = o as AssetAdministrationShell;
            var asset = aas.AssetInformation;
            if (asset != null)
            {
                // string url = WebUtility.UrlEncode(asset.identification.id);
                string url = asset.GlobalAssetId;
                // string link = prefix + hostPort + "/server/getaasxbyassetid/" + url;
                // string link = Program.externalRest + "/server/getaasxbyassetid/" + url;
                string link = url;

                QRCodeGenerator qrGenerator = new QRCodeGenerator();
                QRCodeData qrCodeData = qrGenerator.CreateQrCode(link, QRCodeGenerator.ECCLevel.Q);
                QRCode qrCode = new QRCode(qrCodeData);
                Bitmap qrCodeImage = qrCode.GetGraphic(20);
                using (System.IO.MemoryStream memory = new System.IO.MemoryStream())
                {
                    qrCodeImage.Save(memory, System.Drawing.Imaging.ImageFormat.Bmp);
                    string base64 = Convert.ToBase64String(memory.ToArray());

                    Program.generatedQrCodes.Add(item.Tag, base64);

                }
                return;
            }
        }

        return;
    }

    bool hasDownloadFile(Item item)
    {
        return false;

        if (item == null)
        {
            return false;
        }

        object o = item.Tag;

        if (o is AasCore.Aas3_0.File f)
        {

            // Test for /aasx/
            string[] split = f.Value.Split(new Char[] { '/' });
            if (split.Length == 2 || split[1].ToLower() == "aasx")
            {
                return true;
            }
        }

        return false;
    }

    string getLink(Item item, out bool external)
    {
        external = false;

        if (item == null)
        {
            return "";
        }

        string prefix = "http://";
        string hostPort = Program.hostPort;

        string[] split = Program.hostPort.Split(':');
        if (split[0].ToLower() == "admin-shell-io.com")
        {
            prefix = "https://";
            hostPort = split[0] + ":" + (Convert.ToInt32(split[1]) + 1);
        }

        object o = item.Tag;

        if (o == null && Program.envSymbols[item.envIndex] == "L")
        {
            // return prefix + hostPort + "/server/getaasx/" + Convert.ToString(selectedNode.envIndex);
            return Program.externalRest + "/server/getaasx/" + Convert.ToString(selectedNode.envIndex);
        }

        if (o is AssetAdministrationShell)
        {
            // return prefix + hostPort + "/server/getaasx/" + Convert.ToString(selectedNode.envIndex);
            //return Program.externalRest + "/server/getaasx/" + Convert.ToString(selectedNode.envIndex);
            string currentUrl = NavigationManager.Uri;
            return currentUrl + "packages/" + Base64UrlEncoder.Encode(Convert.ToString(selectedNode.envIndex));
        }

        if (o is AasCore.Aas3_0.File || o is Property)
        {
            string value = "";

            if (o is AasCore.Aas3_0.File)
            {
                value = (o as AasCore.Aas3_0.File).Value;
            }
            if (o is Property)
            {
                value = (o as Property).Value;
            }

            if (value == null || value == "")
                return "";

            split = value.Split(new Char[] { ':' });
            if (split[0].ToLower() == "http" || split[0].ToLower() == "https")
            {
                external = true;
                return value;
            }

            // Test for /aasx/
            split = value.Split(new Char[] { '/' });
            if (split.Length > 1)
            {
                if (split.Length == 2 || split[1].ToLower() == "aasx")
                {
                    // return prefix + hostPort + "/server/getfile/" + item.envIndex.ToString() + value;
                    //return Program.externalRest + "/server/getfile/" + item.envIndex.ToString() + value;   //Old Grapevine implementation
                    string idShortPath = item.Text;
                    string submodelId = "", aasId = "";
                    var currentParentItem = item.parent;
                    while (currentParentItem != null)
                    {
                        if (currentParentItem is Item parentItem)
                        {
                            var parent = parentItem.Tag;
                            if(parent is IIdentifiable identifiable)
                            {
                                if(parent is Submodel submodel)
                                {
                                    submodelId = submodel.Id;
                                }
                                else if(parent is AssetAdministrationShell aas)
                                {
                                    aasId = aas.Id;
                                }
                            }
                            else if(parent is IReferable referable)
                            {
                                idShortPath = referable.IdShort + "." + idShortPath;
                            }
                            currentParentItem = parentItem.parent;
                        }
                    }

                    string currentUrl = NavigationManager.Uri;
                    // return currentUrl + "shells/" + Base64UrlEncoder.Encode(aasId) + "/submodels/"+ Base64UrlEncoder.Encode(submodelId) + 
                    // "/submodel/submodel-elements/" + idShortPath + "/attachment";
                    return currentUrl + "shells/" + Base64UrlEncoder.Encode(aasId) + "/submodels/"+ Base64UrlEncoder.Encode(submodelId) + 
                    "/submodel-elements/" + idShortPath + "/attachment";
                    // return currentUrl + "submodels/"+ Base64UrlEncoder.Encode(submodelId) + 
                    // "/submodelelements/" + idShortPath + "/attachment";

                }
            }
        }

        return "";
    }

    string getSymbols(Item item)
    {
        if (item == null)
        {
            return "";
        }

        string ret = "";
        object o = item.Tag;

        if (o is AssetAdministrationShell)
        {
            string symbols = Program.envSymbols[item.envIndex];

            if (symbols != null)
            {
                string[] s = symbols.Split(';');

                for (int i = 0; i < s.Length; i++)
                {
                    switch (s[i])
                    {
                        case "L":
                            ret += "ENCRYPTED ";
                            break;
                        case "S":
                            ret += "SIGNED ";
                            break;
                        case "V":
                            ret += "VALIDATED ";
                            break;
                    }
                }
            }
        }

        return ret;
    }

    /// <summary>
    /// This method list added to check if Node is only SubmodelElementCollection (from V2)
    /// 
    /// </summary>
    /// <param name="item"></param>
    /// <returns></returns>
    bool IsSmColl(Item item)
    {
        if(item == null)
        {
            return false;
        }

        if(item.Tag is SubmodelElementList)
        {
            return false;
        }

        if(item.Tag is SubmodelElementCollection)
        {
            return true;
        }

        return false;
    }

    string ViewNodeType(Item item)
    {
        if (item == null)
        {
            return "";
        }

        string ret = "";

        if (item.Type != null)
        {
            ret = item.Type + " ";
        }

        object o = item.Tag;

        /*
        if (o is Referable)
        {
        ret = (o as Referable).GetElementName();
        return (ret);
        }
        */

        if (o is string && item.Text.Contains("/readme"))
        {
            ret += item.Text;
        }

        if (o == null && Program.envSymbols[item.envIndex] == "L")
        {
            ret += "AASX2";
        }

        if (o is AssetAdministrationShell)
        {
            ret += "AAS";
        }
        if (o is Submodel)
        {
            ret += "Sub";
        }
        if (o is ISubmodelElement)
        {
            if(o is SubmodelElementList)
            {
                ret += "SML";
            }
            else if (o is SubmodelElementCollection)
            {
                ret += "Coll";
            }
            if (o is Property)
            {
                ret += "Prop";
            }
        }
        if (o is Operation)
        {
            ret += "Opr";
        }
        if (o is AasCore.Aas3_0.File)
        {
            ret += "File";
        }
        if (o is Blob)
        {
            ret += "Blob";
        }
        if (o is AasCore.Aas3_0.Range)
        {
            ret += "Range";
        }
        if (o is MultiLanguageProperty)
        {
            ret += "Lang";
        }
        if (o is RelationshipElement)
        {
            ret += "Rel";
        }
        if (o is ReferenceElement)
        {
            ret += "Ref";
        }
        if (o is Entity)
        {
            ret += "Ent";
        }
        if (o is BasicEventElement)
        {
            ret += "Evt";
        }
        if(o is AnnotatedRelationshipElement)
        {
            ret += "RelA";
        }

        return (ret);
    }

    string ViewTimeStamp(Item item)
    {
        if (item == null)
        {
            return "";
        }

        string ret = "";

        object o = item.Tag;

        if (o is IReferable r)
            // ret += " (" + r.TimeStamp.Ticks + ") ";
            ret += " (" + r.TimeStamp.ToString("yy-MM-dd HH:mm:ss.fff") + ") ";

        return ret;
    }

    string ViewNodeID(Item item)
    {
        if (item == null)
        {
            return "";
        }

        string ret = "NULL";

        object o = item.Tag;

        if (o == null && Program.envSymbols[item.envIndex] == "L")
        {
            ret = item.Text;
        }

        if (o is string && item.Text.Contains("/readme"))
        {
            ret = " ";
        }

        if (o is AssetAdministrationShell)
        {
            var aas = o as AssetAdministrationShell;
            ret = aas.IdShort;
        }
        if (o is Submodel)
        {
            var sm = o as Submodel;
            ret = "";
            if (sm.Kind != null && sm.Kind == ModellingKind.Template)
                ret += "<T> ";
            ret += sm.IdShort;
        }
        if (o is ISubmodelElement)
        {
            var sme = o as ISubmodelElement;
            ret = "";
            ret += sme.IdShort;
        }
        if (o is AasCore.Aas3_0.File f)
        {
            ret = "";
            ret += f.IdShort;
        }
        if (o is Blob)
        {
            var b = o as Blob;
            ret = "";
            ret += b.IdShort;
        }
        if (o is AasCore.Aas3_0.Range)
        {
            var r = o as AasCore.Aas3_0.Range;
            ret = "";
            ret += r.IdShort;
        }
        if (o is MultiLanguageProperty)
        {
            var mlp = o as MultiLanguageProperty;
            ret = "";
            ret += mlp.IdShort;
        }
        return (ret);
    }

    string GetHtmlId(Item item)
    {
        string ret = ViewNodeID(item);
        if (item.parent != null)
        {
            ret = GetHtmlId(item.parent as Item) + "." + ret;
        }
        return (ret);
    }

    string ViewNodeInfo(Item item)
    {
        if (item == null)
        {
            return "";
        }

        string ret = "";

        object o = item.Tag;

        if (o is AssetAdministrationShell)
        {
            var aas = o as AssetAdministrationShell;
            // ret = aas.identification.ToString();
        }
        if (o is Submodel)
        {
            var sm = o as Submodel;
            // ret = sm.identification.ToString();
            if (sm.Qualifiers != null && sm.Qualifiers.Count > 0)
            {
                ret += " @QUALIFIERS";
            }
        }
        if (o is SubmodelElementCollection)
        {
            var sme = o as SubmodelElementCollection;
            // ret = sm.identification.ToString();
            if (sme.Value != null)
            {
                if (sme.Value.Count > 0)
                {
                    ret += " #" + sme.Value.Count;
                }
            }
            if (sme.Qualifiers != null && sme.Qualifiers.Count > 0)
            {
                ret += " @QUALIFIERS";
            }
        }
        if (o is ISubmodelElement)
        {
            if (o is Property)
            {
                var prop = o as Property;
                if (prop.Value!= null && prop.Value != "")
                {
                    string v = prop.Value;
                    if (v.Length > 100)
                        v = v.Substring(0, 100) + " ..";
                    ret = " = " + v;
                }
                if (prop.Qualifiers != null && prop.Qualifiers.Count > 0)
                {
                    ret += " @QUALIFIERS";
                }
            }
            if (o is AasCore.Aas3_0.File f)
            {
                if (f.Value != null)
                    ret = " = " + f.Value;
                if (f.Qualifiers != null && f.Qualifiers.Count > 0)
                {
                    ret += " @QUALIFIERS";
                }
            }
        }
        if (o is AasCore.Aas3_0.Range)
        {
            var r = o as AasCore.Aas3_0.Range;
            if (r.Min != null && r.Max != null)
                ret = " = " + r.Min + " .. " + r.Max;
            if (r.Qualifiers != null && r.Qualifiers.Count > 0)
            {
                ret += " @QUALIFIERS";
            }
        }
        if (o is MultiLanguageProperty)
        {
            var mlp = o as MultiLanguageProperty;
            var ls = mlp.Value;
            if (ls != null)
            {
                ret = " = ";
                for (int i = 0; i < ls.Count; i++)
                {
                    ret += ls[i].Language + " ";
                    if (i == 0)
                        ret += ls[i].Text + " ";
                }
            }
            if (mlp.Qualifiers != null && mlp.Qualifiers.Count > 0)
            {
                ret += " @QUALIFIERS";
            }
        }
        return (ret);
    }

    string ViewNodeDetails(Item item, int line, int col)
    {
        if (item == null)
        {
            return "";
        }

        // string ret = "NULL";
        string ret = "";

        object o = item.Tag;

        if (o == null)
        {
            return "";
        }

        if (o is AssetAdministrationShell)
        {
            string subjectIssuer = null;

            ret = "";
            var aas = o as AssetAdministrationShell;

            var asset = aas.AssetInformation;

            switch (line)
            {
                case 0:
                    if (col == 0)
                        ret = "ID";
                    if (col == 1)
                        ret = aas.Id + "";
                    if (col == 2)
                        ret = " ==> " + Base64UrlEncoder.Encode(aas.Id) + "";
                    break;
                case 1:
                    if (asset != null)
                    {
                        if (col == 0)
                            ret = "ASSET";
                        if (col == 1)
                            ret = asset.GlobalAssetId;
                    }
                    break;
                case 2:
                    if (asset != null)
                    {
                        if (col == 0)
                            ret = "ASSETID";
                        if (col == 1)
                            ret = asset.GlobalAssetId + "";
                        if (col == 2)
                            if(asset.GlobalAssetId != null)
                            {
                                ret = " ==> " + Base64UrlEncoder.Encode(asset.GlobalAssetId) + "";
                            }
                    }
                    break;
                case 3:
                    if (asset != null)
                    {
                        if (col == 0)
                            ret = "ASSETID URLENCODED";
                        if (col == 1)
                        {
                            string url = WebUtility.UrlEncode(asset.GlobalAssetId);
                            ret = url;
                        }
                    }
                    break;
                /*
                case 3:
                subjectIssuer = Program.envSubjectIssuer[item.envIndex];
                if (subjectIssuer != null)
                            {
                            string[] s = subjectIssuer.Split(';');
                            if (s.Length > 0 && s[0] != "")
                {
                ret = "SUBJECT";
                if (col == 1)
                ret = s[0];
                }
                }
                break;
                case 4:
                subjectIssuer = Program.envSubjectIssuer[item.envIndex];
                if (subjectIssuer != null)
                    {
                        string[] s = subjectIssuer.Split(';');
                        if (s.Length > 1 && s[1] != "")
                        {
                        ret = "ISSUER";
                            if (col == 1)
                            ret = s[1];
                            }
                }
                break;
                */
                case 4:
                    if (aas.Extensions != null)
                    {
                        if (col == 0)
                            ret = "Extensions";
                        if (col == 1)
                        {
                            ret = "";
                            foreach (var e in aas.Extensions)
                            {
                                ret += e.Name + " : " + e.Value + "; ";
                            }
                        }
                    }
                    break;
                case 5:
                case 6:
                case 7:
                case 8:
                case 9:
                    ret = "";
                    break;
            }
            return ret;
        }

        if (o is Submodel)
        {
            var sm = o as Submodel;
            ret = "";
            switch (line)
            {
                case 0:
                    if (col == 0)
                        ret = "ID";
                    if (col == 1)
                        ret = sm.Id + "";
                    if (col == 2)
                        ret = " ==> " + Base64UrlEncoder.Encode(sm.Id) + "";
                    break;
                case 1:
                    if (col == 0)
                        ret = "Semantic ID";
                    if (col == 1)
                    {
                        ret = "NULL";
                        var k = sm.SemanticId?.GetAsExactlyOneKey();
                        if (k != null)
                        {
                            ret = $"[{k.Type}, {k.Value}]";
                        }
                    }
                    break;
                case 2:
                    ret = getQualifiers(sm.Qualifiers, col);
                    break;
                case 3:
                    if (sm.Extensions != null)
                    {
                        if (col == 0)
                            ret = "Extensions";
                        if (col == 1)
                        {
                            ret = "";
                            foreach (var e in sm.Extensions)
                            {
                                ret += e.Name + " : " + e.Value + "; ";
                            }
                        }
                    }
                    break;
                case 4:
                case 5:
                case 6:
                case 7:
                case 8:
                case 9:
                    ret = "";
                    break;
            }
            return ret;
        }

        if (o is Property)
        {
            var prop = o as Property;
            // ret += ", " + prop.value;
            ret = "";
            switch (line)
            {
                case 0:
                    if (col == 0)
                        ret = "Semantic ID";
                    if (col == 1)
                    {
                        ret = "NULL";
                        var k = prop.SemanticId?.GetAsExactlyOneKey();
                        if (k != null)
                        {
                            ret = $"[{k.Type}, {k.Value}]";
                        }
                    }
                    break;
                case 1:
                    if (col == 0)
                        ret = "Value Type";
                    if (col == 1)
                        ret = prop.ValueType + "";
                    break;
                case 2:
                    if (col == 0)
                        ret = "Value";
                    if (col == 1)
                        ret = prop.Value + "";
                    break;
                case 3:
                    ret = getQualifiers(prop.Qualifiers, col);
                    break;
                case 4:
                    if (col == 0)
                        ret = getUnit(item, prop, col);
                    break;
                case 5:
                case 6:
                case 7:
                case 8:
                case 9:
                    ret = "";
                    break;
            }
            return ret;
        }

        if (o is Entity)
        {
            var e = o as Entity;
            // ret += ", " + e.entityType;
            switch (line)
            {
                case 0:
                    if (col == 0)
                        ret = "Semantic ID";
                    if (col == 1)
                    {
                        ret = "NULL";
                        var k = e.SemanticId?.GetAsExactlyOneKey();
                        if (k != null)
                        {
                            ret = $"[{k.Type}, {k.Value}]";
                        }
                    }
                    break;
                case 1:
                    if (col == 0)
                        ret = "Entity Type";
                    if (col == 1)
                        ret = e.EntityType + "";
                    break;
                case 2:
                    ret = "";
                    if (e.EntityType == EntityType.SelfManagedEntity)
                    {
                        if (e.GlobalAssetId != null)
                        {
                            if (col == 0)
                                ret = "Asset";
                            if (col == 1)
                            {
                                var k = e.GlobalAssetId;
                            }
                        }

                        if (e.SpecificAssetIds != null)
                        {
                            if (col == 0)
                                ret = "Asset";
                            if (col == 1)
                            {
                                foreach(var specificAssetId in e.SpecificAssetIds)
                                {
                                    var k = specificAssetId.Value;
                                    if(!string.IsNullOrEmpty(k))
                                    {
                                        ret = "[" + k + "]";
                                    }
                                }
                            }
                        }
                    }
                    break;
                case 3:
                    ret = getQualifiers(e.Qualifiers, col);
                    break;
                case 4:
                case 5:
                case 6:
                case 7:
                case 8:
                case 9:
                    ret = "";
                    break;
            }
            return ret;
        }

        if (o is AasCore.Aas3_0.File f)
        {
            ret += ", " + f.Value;
            switch (line)
            {
                case 0:
                    if (col == 0)
                        ret = "Semantic ID";
                    if (col == 1)
                    {
                        ret = "NULL";
                        var k = f.SemanticId?.GetAsExactlyOneKey();
                        if (k != null)
                        {
                            ret = $"[{k.Type}, {k.Value}]";
                        }
                    }
                    break;
                case 1:
                    if (col == 0)
                        ret = "Value";
                    if (col == 1)
                        ret = f.Value;
                    break;
                case 2:
                    ret = getQualifiers(f.Qualifiers, col);
                    break;
                case 3:
                case 4:
                case 5:
                case 6:
                case 7:
                case 8:
                case 9:
                    ret = "";
                    break;
            }
            return ret;
        }

        if (o is Blob b)
        {
            ret = "";
            switch (line)
            {
                case 0:
                    if (col == 0)
                        ret = "Semantic ID";
                    if (col == 1)
                    {
                        ret = "NULL";
                        var k = b.SemanticId?.GetAsExactlyOneKey();
                        if (k != null)
                        {
                            ret = $"[{k.Type}, {k.Value}]";
                        }
                    }
                    break;
                case 1:
                    if (col == 0)
                        ret = "ContentType";
                    if (col == 1)
                        ret = b.ContentType;
                    break;
                case 2:
                    if (col == 0)
                        ret = "Value";
                    if (col == 1)
                        ret = System.Text.Encoding.ASCII.GetString(b.Value);
                    break;
                case 3:
                    ret = getQualifiers(b.Qualifiers, col);
                    break;
                case 4:
                case 5:
                case 6:
                case 7:
                case 8:
                case 9:
                    ret = "";
                    break;
            }
            return ret;
        }

        if (o is AasCore.Aas3_0.Range)
        {
            var r = o as AasCore.Aas3_0.Range;
            ret = r.IdShort;
            switch (line)
            {
                case 0:
                    if (col == 0)
                        ret = "Semantic ID";
                    if (col == 1)
                    {
                        ret = "NULL";
                        var k = r.SemanticId?.GetAsExactlyOneKey();
                        if (k != null)
                        {
                            ret = $"[{k.Type}, {k.Value}]";
                        }
                    }
                    break;
                case 1:
                    if (col == 0)
                        ret = "Min";
                    if (col == 1)
                        ret = r.Min + "";
                    break;
                case 2:
                    if (col == 0)
                        ret = "Max";
                    if (col == 1)
                        ret = r.Max + "";
                    break;
                case 3:
                    ret = getQualifiers(r.Qualifiers, col);
                    break;
                case 4:
                    if (col == 0)
                        ret = getUnit(item, r, col);
                    break;
                case 5:
                case 6:
                case 7:
                case 8:
                case 9:
                    ret = "";
                    break;
            }
            return ret;
        }

        if (o is Operation)
        {
            var op = o as Operation;
            // ret = op.idShort;
            switch (line)
            {
                case 0:
                    if (col == 0)
                        ret = "Semantic ID";
                    if (col == 1)
                    {
                        ret = "NULL";
                        var k = op.SemanticId?.GetAsExactlyOneKey();
                        if (k != null)
                        {
                            ret = $"[{k.Type}, {k.Value}]";
                        }
                    }
                    break;
                case 1:
                    if (col == 0)
                        ret = "CountInputs";
                    if (col == 1)
                    {
                        ret = "0";
                        if (op.InputVariables != null)
                        {
                            ret = op.InputVariables.Count + "";
                        }
                    }
                    break;
                case 2:
                    if (col == 0)
                        ret = "CountOutputs";
                    if (col == 1)
                    {
                        ret = "0";
                        if (op.OutputVariables != null)
                        {
                            ret = op.OutputVariables.Count + "";
                        }
                    }
                    break;
                case 3:
                    ret = getQualifiers(op.Qualifiers, col);
                    break;
                case 4:
                case 5:
                case 6:
                case 7:
                case 8:
                case 9:
                    ret = "";
                    break;
            }
            return ret;
        }

        if (o is AnnotatedRelationshipElement)
        {
            var r = o as AnnotatedRelationshipElement;
            // ret = r.idShort;
            switch (line)
            {
                case 0:
                    if (col == 0)
                        ret = "Semantic ID";
                    if (col == 1)
                    {
                        ret = "NULL";
                        var k = r.SemanticId?.GetAsExactlyOneKey();
                        if (k != null)
                        {
                            ret = $"[{k.Type}, {k.Value}]";
                        }
                    }
                    break;
                case 1:
                    if (col == 0)
                        ret = "First";
                    if (col == 1)
                    {
                        ret = "NULL";
                        var k = r.First;
                        if (k != null)
                        {
                            ret = k.Keys.ToStringExtended();
                        }
                    }
                    break;
                case 2:
                    if (col == 0)
                        ret = "Second";
                    if (col == 1)
                    {
                        ret = "NULL";
                        var k = r.Second;
                        if (k != null)
                        {
                            ret = k.Keys.ToStringExtended();
                        }
                    }
                    break;
                case 3:
                    if (col == 0)
                        ret = getQualifiers(r.Qualifiers, col);
                    break;
                case 4:
                case 5:
                case 6:
                case 7:
                case 8:
                case 9:
                    ret = "";
                    break;
            }
            return ret;
        }
        if (o is RelationshipElement)
        {
            var r = o as RelationshipElement;
            // ret = r.idShort;
            switch (line)
            {
                case 0:
                    if (col == 0)
                        ret = "Semantic ID";
                    if (col == 1)
                    {
                        ret = "NULL";
                        var k = r.SemanticId?.GetAsExactlyOneKey();
                        if (k != null)
                        {
                            ret = $"[{k.Type}, {k.Value}]";
                        }
                    }
                    break;
                case 1:
                    if (col == 0)
                        ret = "First";
                    if (col == 1)
                    {
                        ret = "NULL";
                        var k = r.First;
                        if (k != null)
                        {
                            ret = k.Keys.ToStringExtended();
                        }
                    }
                    break;
                case 2:
                    if (col == 0)
                        ret = "Second";
                    if (col == 1)
                    {
                        ret = "NULL";
                        var k = r.Second;
                        if (k != null)
                        {
                            ret = k.Keys.ToStringExtended();
                        }
                    }
                    break;
                case 3:
                    ret = getQualifiers(r.Qualifiers, col);
                    break;
                case 4:
                case 5:
                case 6:
                case 7:
                case 8:
                case 9:
                    ret = "";
                    break;
            }
            return ret;
        }

        if (o is ReferenceElement)
        {
            var r = o as ReferenceElement;
            // ret = r.idShort;
            switch (line)
            {
                case 0:
                    if (col == 0)
                        ret = "Semantic ID";
                    if (col == 1)
                    {
                        ret = "NULL";
                        var k = r.SemanticId?.GetAsExactlyOneKey();
                        if (k != null)
                        {
                            ret = $"[{k.Type}, {k.Value}]";
                        }
                    }
                    break;
                case 1:
                    if (col == 0)
                        ret = "Value";
                    if (col == 1)
                    {
                        ret = "NULL";
                        /*
                        if (r.GetModelReference() != null)
                        {
                            var k = r.Value.Keys;
                            if (k != null)
                            {
                                ret = k.ToStringExtended();
                            }
                        }
                        */
                        if (r.Value != null)
                        {
                            var k = r.Value.Keys;
                            if (k != null)
                            {
                                ret = k.ToStringExtended();
                            }
                        }
                    }
                    break;
                case 2:
                    ret = getQualifiers(r.Qualifiers, col);
                    break;
                case 3:
                case 4:
                case 5:
                case 6:
                case 7:
                case 8:
                case 9:
                    ret = "";
                    break;
            }
            return ret;
        }

        if (o is MultiLanguageProperty)
        {
            var mlp = o as MultiLanguageProperty;
            var ls = mlp.Value;
            for (int i = 0; i < ls.Count; i++)
            {
                ret += ls[i].Language + " ";
            }
            switch (line)
            {
                case 0:
                    if (col == 0)
                        ret = "Semantic ID";
                    if (col == 1)
                    {
                        ret = "NULL";
                        var k = mlp.SemanticId?.GetAsExactlyOneKey();
                        if (k != null)
                        {
                            ret = $"[{k.Type}, {k.Value}]";
                        }
                    }
                    break;
                case 1:
                case 2:
                case 3:
                case 4:
                    ret = "";
                    if (ls.Count > line - 1)
                    {
                        if (col == 0)
                            ret = ls[line - 1].Language;
                        if (col == 1)
                            ret = ls[line - 1].Text + "";
                    }
                    break;
                case 5:
                    ret = getQualifiers(mlp.Qualifiers, col);
                    break;
                case 6:
                case 7:
                case 8:
                case 9:
                    ret = "";
                    break;
            }
            return ret;
        }

        if (o is ISubmodelElement)
        {
            var sme = o as ISubmodelElement;
            // ret = sme.idShort + ", " + sme.semanticId;
            switch (line)
            {
                case 0:
                    if (col == 0)
                        ret = "Semantic ID";
                    if (col == 1)
                    {
                        ret = "NULL";
                        var k = sme.SemanticId?.GetAsExactlyOneKey();
                        if (k != null)
                        {
                            ret = $"[{k.Type}, {k.Value}]";
                        }
                    }
                    break;
                case 1:
                    ret = getQualifiers(sme.Qualifiers, col);
                    break;
                case 2:
                case 3:
                case 4:
                case 5:
                case 6:
                case 7:
                case 8:
                case 9:
                    ret = "";
                    break;
            }
            return ret;
        }

        return (ret);
    }

    static string getQualifiers(List<IQualifier> q, int col)
    {
        string ret = "";

        if (q != null && q.Count > 0)
        {
            if (col == 0)
                ret = "Qualifiers";
            if (col == 1)
            {
                ret = "";
                for (int i = 0; i < q.Count; i++)
                {
                    if (i != 0)
                        ret += ", ";
                    if (q[i].Type != null && q[i].Type != "")
                    {
                        ret += q[i].Type + " ";
                    }
                    if (q[i].Value != null && q[i].Value != "")
                    {
                        ret += "= " + q[i].Value;
                    }
                }
            }
        }
        return ret;
    }

    public string getUnit(Item item, ISubmodelElement se, int col)
    {
        string ret = "";
        if (se.SemanticId == null || se.SemanticId.Keys != null || se.SemanticId.Keys.Count != 0)
        {
            return ret;
        }
        var cd = Program.env[item.envIndex].AasEnv.FindConceptDescriptionByReference(se.SemanticId);
        if (cd != null)
        {
            // TODO (jtikekar, 2023-09-04): temporarily commented
            //var iec = cd.GetIEC61360();
            //if (iec != null)
            //{
            //    ret = "Unit";
            //    if (col == 1)
            //    {
            //        ret = iec.unit;
            //        if (iec.unitId != null && iec.unitId.Value != null && iec.unitId.Value.Count > 0)
            //            ret += " (UnitId = " + iec.unitId.Value.ToString() + ")";
            //    }
            //}
        }
        return ret;
    }
}

<style>
.modal-fullscreen {
  padding: 0 !important;
}
.modal-fullscreen .modal-dialog {
  width: 100%;
  max-width: none;
  height: 100%;
  margin: 0;
}
.modal-fullscreen .modal-content {
  height: 100%;
  border: 0;
  border-radius: 0;
}
.modal-fullscreen .modal-body {
  overflow-y: auto;
}
</style>
